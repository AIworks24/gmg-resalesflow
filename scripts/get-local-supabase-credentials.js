#!/usr/bin/env node

/**
 * Helper script to get local Supabase credentials
 * Usage: node scripts/get-local-supabase-credentials.js
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('ğŸ” Checking local Supabase status...\n');

try {
  // Get Supabase status
  const statusOutput = execSync('supabase status', { encoding: 'utf-8' });
  console.log(statusOutput);

  // Parse credentials from output
  const apiUrlMatch = statusOutput.match(/API URL:\s+(.+)/);
  const anonKeyMatch = statusOutput.match(/anon key:\s+(.+)/);
  const serviceRoleKeyMatch = statusOutput.match(/service_role key:\s+(.+)/);

  if (!apiUrlMatch || !anonKeyMatch || !serviceRoleKeyMatch) {
    console.log('\nâš ï¸  Could not parse all credentials from status output.');
    console.log('Please copy them manually from the output above.\n');
    process.exit(0);
  }

  const apiUrl = apiUrlMatch[1].trim();
  const anonKey = anonKeyMatch[1].trim();
  const serviceRoleKey = serviceRoleKeyMatch[1].trim();

  console.log('\nğŸ“‹ Extracted Credentials:');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log(`API URL: ${apiUrl}`);
  console.log(`Anon Key: ${anonKey.substring(0, 50)}...`);
  console.log(`Service Role Key: ${serviceRoleKey.substring(0, 50)}...`);
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');

  // Check if .env.local exists
  const envPath = path.join(process.cwd(), '.env.local');
  const envExists = fs.existsSync(envPath);

  if (envExists) {
    // Read existing .env.local
    let envContent = fs.readFileSync(envPath, 'utf-8');

    // Update or add Supabase variables
    const updates = {
      'NEXT_PUBLIC_SUPABASE_URL': apiUrl,
      'NEXT_PUBLIC_SUPABASE_ANON_KEY': anonKey,
      'SUPABASE_SERVICE_ROLE_KEY': serviceRoleKey,
    };

    let updated = false;
    for (const [key, value] of Object.entries(updates)) {
      const regex = new RegExp(`^${key}=.*$`, 'm');
      if (regex.test(envContent)) {
        envContent = envContent.replace(regex, `${key}=${value}`);
        updated = true;
      } else {
        envContent += `\n${key}=${value}`;
        updated = true;
      }
    }

    if (updated) {
      fs.writeFileSync(envPath, envContent);
      console.log('âœ… Updated .env.local with local Supabase credentials!\n');
    } else {
      console.log('â„¹ï¸  .env.local already contains these values.\n');
    }
  } else {
    // Create new .env.local
    const envContent = `# Local Supabase Configuration
# Generated by get-local-supabase-credentials.js

NEXT_PUBLIC_SUPABASE_URL=${apiUrl}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${anonKey}
SUPABASE_SERVICE_ROLE_KEY=${serviceRoleKey}
NEXT_PUBLIC_SITE_URL=http://localhost:3000
`;

    fs.writeFileSync(envPath, envContent);
    console.log('âœ… Created .env.local with local Supabase credentials!\n');
  }

  console.log('ğŸ’¡ Next steps:');
  console.log('   1. Review .env.local to ensure all variables are correct');
  console.log('   2. Restart your Next.js dev server: npm run dev');
  console.log('   3. Access Supabase Studio: http://127.0.0.1:54323\n');

} catch (error) {
  if (error.message.includes('Command failed')) {
    console.error('âŒ Error: Supabase is not running locally.');
    console.error('\nğŸ’¡ To start Supabase, run:');
    console.error('   supabase start\n');
    process.exit(1);
  } else {
    console.error('âŒ Error:', error.message);
    process.exit(1);
  }
}


